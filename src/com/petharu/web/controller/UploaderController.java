package com.petharu.web.controller;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.PrintWriter;
import java.util.Collection;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.Part;

@WebServlet("/uploader")
@MultipartConfig (
    fileSizeThreshold = 1024*1024,
    maxFileSize = 1024*1024*500, // 50?На?Миъ│дьШЩ
    maxRequestSize = 1024*1024*500*5 // 50?На?Миъ│дьШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ 5?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ
)
public class UploaderController extends HttpServlet {

	@Override
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		// ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?Л╕?У╕?ШЩ?На?Л╣ъ╣НьШЩ
		request.setCharacterEncoding("UTF-8");
		String p = request.getParameter("p");
		
		Part fpart = request.getPart("f"); // ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ, ?На?ПЩ?ШЩ?ЩШ ???На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?К╕?На?ПЩ?ШЩ
		String fileName = fpart.getSubmittedFileName(); // ?На?ПЩ?ШЩ?На?МЬ?У╕?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?Л▒ыкМьШЩ
		InputStream fis = fpart.getInputStream(); // ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?К╕?На?ПЩ?ШЩ
	
		ServletContext application = request.getServletContext(); // ?На?ПЩ?ШЩ?На?ЛЬыкМьШЩ?На?ПЩ?ШЩ?На?Л▒?З╜?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?Ная┐? ?На?ПЩ?ШЩ?На?ПЩ?ШЩ, ?На?МХыкМьШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?МЬ?Ц╡?ШЩ?На?ПЩ?ШЩ ?На?Л▒?Ц┤ъ░??На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ, ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?Ная┐?(ServletContext)?На?ПЩ?ШЩ ?На?Лн?Ъ╕?ШЩ
		
		String path = "/upload"; // ?На?ПЩ?ШЩ?На?Л╕?У╕?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?Ная┐?, ?На?МФ?МР?ШЩ ?На?ПЩ?ШЩ?БМ?Ная┐? ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩчобхНая┐? ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?МФ?Ц╡?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?Ная┐? ?На?ПЩ?ШЩ?На?ПЩ?ШЩ, ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?Ная┐? ?На?МХыкМьШЩ ?На?ПЩ?ШЩ?На?Л▒ып?ыдДьШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?Л╣ыкМьШЩ ?На?Лл?У╕?ШЩ
		if(p != null && !p.equals(""))
			path = p;
		
		String realPath = application.getRealPath(path); // ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩч╜РхНая┐? ?На?ПЩ?ШЩ?Ин?В╝?ШЩ?Ная┐?
		
		File pathFile = new File(realPath); // ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?Ная┐?
		if(!pathFile.exists()) // ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ
			pathFile.mkdirs(); // ?На?ПЩ?ШЩч╜РхНая┐? ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?Ная┐?
		
		String filePath = realPath + File.separator + fileName; // ?На?ПШ?ШБь▓┤хНа?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?МШъ│дьШЩ ?На?МХыкМьШЩ ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ
		FileOutputStream fos = new FileOutputStream(filePath);
		
		System.out.println("aaa" + realPath);
		
		byte[] buf = new byte[1024];
		int len = 0;
		
		while((len = fis.read(buf, 0, 1024)) >= 0) // ?На?МН?МР?ШЩ 1024?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?Л╝ы▒ДьШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ, len: ?На?МЙыдДьШЩ ?На?ПЩ?ШЩ?К╕?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?МЬ?Ъ╕?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?К╕ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ(?На?МН?МР?ШЩ 1024)
			fos.write(buf, 0, len); // ?На?Л╗?Ц╡?ШЩ?На?ПЩ?ШЩ?Ная┐? len?На?ПЩ?ШЩ?Б╝ write?На?Л╣?МР?ШЩ ?На?ПЩ?ШЩ
		
		fos.flush();
		fos.close();
		fis.close();
		
		PrintWriter out = response.getWriter();

		out.println(path + "/" + fileName); // response?На?ПЩ?ШЩ ?На?ПЩ?ШЩ?На?ПЩ?ШЩ?На?ПЩ?ШЩ!

	}	
}
